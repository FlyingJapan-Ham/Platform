# 주문 데이터 추출 가이드

이 프로젝트는 네이버 커머스 주문 API에서 특정 기간의 주문을 조회하고, HTML 및 JSON 리포트를 생성하는 PHP 스크립트를 포함합니다. 이 문서는 현재 설정과 사용 방법을 정리하여 재사용과 유지보수를 돕기 위한 것입니다.

## 구성 요소

- `orders_today.php`  
  네이버 커머스 API에 인증 후 주문 데이터를 조회하고, 결과를 가공하여 HTML/JSON 리포트를 생성합니다.
- `orders_result.html`  
  마지막 실행 결과가 저장되는 기본 HTML 보고서입니다. 실행할 때마다 동일 파일을 덮어써 최신 상태를 유지합니다.
- (선택) `orders_result.json`  
  `--format=json` 옵션을 사용해 출력한 결과를 필요 시 리다이렉트하여 저장할 수 있습니다.
- `analyze_orders.php`  
  주문 옵션별 통계를 빠르게 확인할 수 있는 보조 스크립트입니다.
## 실행 환경 및 의존성

- PHP 8.1 이상 (CLI)
- `curl` 확장
- Composer(선택)
  - `composer.json`은 오토로더 구성을 위해 존재하지만, 현재 추가 패키지는 사용하지 않습니다.

## 인증 정보

- 네이버 커머스 API 클라이언트 자격 증명이 `orders_today.php` 상단 상수(`CLIENT_ID`, `CLIENT_SECRET`)에 하드코딩돼 있습니다.
- 호출 시 bcrypt 전자서명(`generateSignature`)을 생성해 OAuth2 Client Credential 방식으로 토큰을 발급받습니다.

> **보안 주의**: 실제 서비스에서는 자격 증명을 환경 변수나 별도 설정 파일로 분리하세요.

## 조회 조건

- **API 엔드포인트**
  - 토큰: `https://api.commerce.naver.com/external/v1/oauth2/token`
  - 주문: `https://api.commerce.naver.com/external/v1/pay-order/seller/product-orders`
- **기간 조건**
  - `orders_today.php` 실행 시 `--from=YYYY-MM-DD`, `--to=YYYY-MM-DD` 옵션으로 날짜 범위를 지정합니다.
  - 날짜는 한국 시간(Asia/Seoul)을 기준으로 각 날짜별 `00:00:00.000 ~ 23:59:59.999` 범위를 조회합니다.
- **rangeType**
  - `PAYED_DATETIME` 기준 (결제일시).
- **페이지 크기**
  - `size=300` (일별 최대 300건).
- **리스펀스 처리**
  - API 호출 실패 시 429, GW.RATE_LIMIT 등을 감지하여 최대 5회까지 재시도(지수 백오프)합니다.
- **필터링**
  - 주문 상태에 `CANCEL` 또는 `RETURN` 문자열이 포함된 항목은 결과에서 제외합니다.

## 컬럼 맵핑

- 옵션 문자열을 `라벨: 값 / 라벨2: 값2` 형태로 파싱하고 다음 컬럼에 매핑합니다:
  - `출국일/시간 렌탈 (체크박스)`
  - `귀국일/시간`
  - `반납일 (체크박스)`
  - `파손 확인 (체크박스)`
  - `상세페이지 내용확인/약관 동의`
  - `상품선택`
- 최근 API가 `대여일`, `반납일`, `약관동의` 등 다양한 라벨을 반환하는 문제에 대응하기 위해 라벨 매핑을 확장했습니다.
- 상품별 카테고리 수량은 상품명·옵션값을 기반으로 `마리오파워업밴드`, `해리포터지팡이`, `트라이크` 등으로 분류합니다.  
  콤보 상품(예: `productId = 12325205237`)은 상품명만으로도 각각의 수량을 집계하도록 보완했습니다.

## 그룹화 로직

- 주문 데이터는 **로그인 ID(없으면 구매자명)** + **결제일시** 조합으로 그룹화합니다.
- 같은 결제 시각에 여러 상품이 결제되면 한 행으로 묶이며, 상품명은 줄바꿈으로 모두 표시됩니다.
- 그룹마다 다음 정보를 계산합니다:
  - 옵션 필드(출국, 귀국, 체크박스 등)의 유니크 값
  - 카테고리 수량 합계
  - 주문 상태, 결제/배송 일시, 옵션 불일치 여부
- `orders_result.html`에는 `아답터`, `비고` 빈 컬럼을 포함하여 수작업 메모가 가능하도록 했습니다.

## 실행 예시

```bash
# 오늘(또는 지정 기간) 주문을 HTML로 저장 & 출력
php orders_today.php --from=2025-10-09 --to=2025-10-09

# JSON 형식으로 출력 (stdout)하고 파일로 저장
php orders_today.php --from=2025-10-09 --to=2025-10-09 --format=json > orders_result.json

# 특정 기간 누적 데이터 분석
php analyze_orders.php 2025-10-01 2025-10-09
```

## 출력 파일

- `orders_result.html`: 항상 최신 실행 결과로 덮어씁니다.
- `orders_result.json`: JSON 결과(`--format=json`)를 리다이렉트하여 보관할 때 사용하는 예시 이름입니다.
- 과거 특정 일자를 보관하고 싶다면 실행 시 별도의 파일명으로 리다이렉트하여 저장하면 됩니다.

## 커스터마이즈

- **라벨/카테고리 확장**  
  새 옵션 라벨이 추가되면 `OPTION_COLUMN_CONFIG`, `CATEGORY_COLUMN_CONFIG`에 키워드를 추가하세요.
- **그룹화 조건 변경**  
  예를 들어 주문 번호 단위로 보고 싶다면 `orders_today.php` 내 그룹키 생성 로직을 수정하면 됩니다.
- **UI 수정**  
  HTML 구조는 `orders_today.php` 하단 템플릿에서 정의됩니다. 필요 시 스타일과 컬럼 구성을 조정하세요.

## 트러블슈팅

- **API 인증 실패**  
  클라이언트 ID/시크릿, 서버 시간 동기화를 확인하세요.
- **데이터 누락**  
  `shouldExcludeStatus()`에서 필터링되는 상태인지, 옵션 라벨이 매핑에 포함돼 있는지 확인합니다.
- **중복 표시**  
  그룹 키는 로그인 ID + 결제일시로 구성됩니다. 결제일시가 다르거나 로그인 ID가 비어 있는 경우 그룹이 분리될 수 있습니다.

---

문의 또는 추가 요구 사항이 있으면 README를 갱신하거나 `orders_today.php`에 주석을 추가해서 공유하세요.
